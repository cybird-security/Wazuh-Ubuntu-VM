# Wazuh-Ubuntu-VM
The following documentation is for setting up Wazuh, an open-source SIEM tool, on a headless Ubuntu Server virtual machine. I wanted to do this project to practice documentation and get some practice with SIEM tools. The scope of this document covers the initial setup of the virtual machines for the Wazuh host. Wazuh agents will be configured later.

## Table of Contents

- [I. Requirements](#i-requirements)
- [II. Preliminary Steps](#ii-preliminary-steps)
- [III. Virtual Machine Configuration](#iii-virtual-machine-configuration)
- [IV. Ubuntu Server Configuration](#iv-ubuntu-server-configuration)
- [V. Network Configuration (Optional)](#v-network-configuration-optional---if-using-a-default-gateway-in-lan-segment)
- [VI. Wazuh Installation](#vi-wazuh-installation)
- [VII. Security Considerations](#vii-security-considerations)
---

## I. Requirements

### Virtualization-capable processor

**a.** Verifiable in Windows by using the Windows search on your taskbar (magnifying glass icon) or in the Start menu (the Windows logo), and searching "System Information." Click on System Information.

**b.** In System Summary (which should be the menu you are greeted with), scroll to the bottom and verify that "HyperV - Virtualization Enabled in Firmware" is set to "Yes". If it is not, you will need to refer to your motherboard manual or other guide to enable virtualization.

---

### 16 GB of RAM

**a.** Verifiable in System Information under System Summary by noting the value next to "Total Physical Memory".

**b.** Don't worry about a lower "Available Physical Memory", since your computer will reallocate memory and clear caches when necessary to run the VMs.

---

### 60+ GB Storage

**a.** Verifiable by right-clicking the Windows icon on your taskbar and selecting "Disk Management".

**b.** Look for the volume you intend to install and configure the VMs on (in my case, it is the volume labeled `C:`) and ensure you have enough free space for both the Ubuntu Server `.iso` file and VM storage allocation.

**Note:** Wazuh and Ubuntu Server have lower requirements than 60 GB, but I ran into issues when trying to install Wazuh with less storage than that.

---

### 4-core processor

**a.** Verifiable in System Information under System Summary by noting the value next to "Processor".

**b.** If the value does not state the core count of your processor, you can perform a web search of your processor to verify the core count as well.

---

## II. Preliminary Steps

### VMware Installation

**a.** If you do not have VMware Workstation Pro, you can download it by navigating to Broadcom's official website, creating an account, and downloading the latest version there.

**b.** You may also download version 17.6.3 from my Proton Drive links below. Note that these versions will eventually be outdated, but I am providing them for convenience.

- Windows: https://drive.proton.me/urls/Q8Y5AS3AYW#xyCfTbKqQNp6
- Linux: https://drive.proton.me/urls/VTHJ3R1TD0#MgRQKas0gGuL

**Note:** I am using VMware Workstation Pro as it is a more feature-rich hypervisor than VirtualBox, and I have more experience with it than other hypervisors. It is absolutely possible to run this configuration using a bare metal instance or another hypervisor, but the instructions will differ.

---

### Download Ubuntu Server

**a.** Download the latest Ubuntu Server `.iso` file: https://ubuntu.com/download/server

**b.** After installing VMware, downloading the Ubuntu Server `.iso` file, and verifying your computer (the "Host") meets the aforementioned requirements, we can begin installing Ubuntu Server and Wazuh.

---

## III. Virtual Machine Configuration

1. Open VMware Workstation Pro.
    
2. Navigate to the menu on the top bar that says "File". Select it, then select "New Virtual Machine..." from the drop-down menu.
    
3. In the New Virtual Machine Wizard, select the "Typical (recommended)" radio button and click Next.
    
4. Verify "Installer disc image file (iso)" is selected, then click "Browse...". Locate the Ubuntu Server `.iso` you downloaded earlier, click on it, then select "Open". Click Next.
    
5. Give the VM a name of your choosing and install it in your preferred location.  
    **a.** Ensure that your installation location should have enough space on the drive to contain the VM.
    
6. Set the "Maximum in disk size (GB)" to 60. Although this space is not used all at once, you will need enough space to complete the Ubuntu Server installation, install Wazuh, and store the logs/files generated by Wazuh.
    
7. For the purposes of this lab, select "Store virtual disk as a single file". Click Next.  
    **a.** Splitting the virtual disk into multiple files is useful when sharing it, as it creates chunks of the disk to upload/download rather than one big file. Since we are not sharing the VM over a network or the Internet, storing it as a single file maintains simplicity.
    
8. On the final menu of the Wizard, you will see a summary of the hardware specifications of the VM. Since we need sufficient resources to run Wazuh (and a means to connect it to other machines), select "Customize Hardware..."
    
9. Under Memory, allocate 8 GB of memory using the slider or by entering "8192" in the field next to "Memory for this virtual machine".  
	**a.** Although the recommended memory may state 4 GB, we will need a bit more to handle all the components of Wazuh.
    
10. Under Processors, set "Number of processors" to 2 and "Number of cores per processor" to 2. Anything that multiplies to 4 total processor cores is sufficient.
    
11. Next to Network Adapter, ensure that the Summary says "NAT". If not, click on Network Adapter and select "NAT: Used to share the host's IP address". This allows the VM to use our computer to connect to the Internet so we can install updates and packages we need later.
    
12. We need the server to connect to other virtual machines to generate Wazuh logs and to experiment with other things later. At the bottom left of the window, select "Add...". Then select "Network Adapter". This new adapter should appear as "Network Adapter 2" on the left-hand side.  
    **a.** Select Network Adapter 2. Then select the "LAN Segments..." button and add a LAN Segment. Enter a name, then click OK. Finally, select the "LAN Segment" radio button and select the LAN segment you just created.
    
13. We are finished configuring the VM in VMware. Select "Close" at the bottom right of the window. Ensure "Power on this virtual machine after creation" is checked, then select "Finish".
    

---

## IV. Ubuntu Server Configuration

1. Upon booting into the GRUB menu for Ubuntu Server, use the `Enter` key to select "Try or Install Ubuntu Server".  
    Henceforth, you will use the arrow keys to navigate between options and the `Enter` key to select options.
    
2. Select your preferred language and keyboard layout, then select Done.
    
3. Select "Ubuntu Server" as the installation base. Leave "Search for third-party drivers" unselected, then select Done.  
    I used the default installation base to ensure compatibility with online guides and Wazuh, and to reduce the number of manually installed packages.
    
4. In the Network configuration menu, you will see two network adapters (ens33 and ens34, in my case). The one that already has an IP address is the default NAT adapter; leave that be.  
    **a.** Select the other adapter with no IP address. It may say "autoconfiguration failed" and "disabled", but we will fix this later.  
    **b.** Select "Edit IPv4", then press `Enter` on the IPv4 Method to view the drop down menu options. Select "Manual".  
    **c.** For "Subnet", enter whatever subnet you would like to use. For beginners, just enter `192.168.1.0/24`.  
    **i.** This is a Class C IP address space with a subnet mask of 255.255.255.0. This leaves more than enough addresses at our disposal, and it is a common configuration.  
    **d.** For "Address", enter the IP address you would like to use for this VM. For beginners, just enter `192.168.1.1`.  
    **i.** If you have other VMs in the LAN segment, ensure your chosen IP does not conflict with another VM.  
    **e.** Since this adapter is part of a LAN segment with no router or default gateway, we do not need to enter a gateway. So leave "Gateway" blank.  
    **f.** We do not need a name server for now, so leave "Name servers" blank.  
    **g.** We don't have any search domains, so leave "Search domains" blank, then select "Save".  
    **h.** Select "Done".
    
5. We are not using a proxy server for now, so leave "Proxy address" blank and select "Done".
    
6. Wait for the mirror address to pass the tests, then select "Done".  
    **a.** If the mirror address test fails, it means the NAT network adapter is not functioning properly. Ensure you did not change anything in the VM settings or alter the NAT adapter settings in the previous Network configuration setup window. If nothing is wrong with either, select "Done" and we'll troubleshoot later.
    
7. In the Guided storage configuration, "Use an entire disk" and "Set up this disk as an LVM group" should be selected by default; if not, select them. Then, select "Done".
    
8. You will be greeted with a summary of the file system. So long as you allocated the maximum storage to 60 GB in the VM configuration earlier, there is nothing to worry about here. Select "Done" and then "Continue".
    
9. Enter your name, a name for the server (this virtual machine), a username (used to login to the server), and a password. We will not be accessing the Internet for very long, so you can use a simple and memorable password. When you're done, select "Done".  
    **a.** In business environments, create a strong password using a password generator or password manager and store it someplace secure. No, a post-it note under your keyboard is not a safe place.
    
10. Upgrade to Ubuntu Pro should default to "Skip for now". If not, select it and then select "Continue".
    
11. Ensure "Install OpenSSH Server" is checked so we can use SSH between VMs later. If you do not plan on using SSH, leave it unselected. Once finished, select "Done".
    
12. Do not install any extra server snaps for now. So select "Done".
    
13. The Ubuntu Server installation should commence. Once finished, select "Reboot Now" when it appears.
    
14. You may receive an error that says "FAILED - Failed unmounting cdrom.mount". This is fine; press Ctrl + Alt at the same time to move exit the VM window, and navigate to the VM button on the top bar of VMware Workstation. Select it, then select "Settings" from the drop-down menu.  
	    **a.** In the new window, select CD/DVD (SATA) from the left hand side. On the right, deselect "Connect at power on" then click OK at the bottom of the window.  
	    **b.** Click the VM button on the top bar again and select Power, then "Restart Guest".  
	    **c.** The VM should boot properly.
	    
15. Login with the credentials you configured earlier, and you're in!

---

## V. Network Configuration (Optional - If using a default gateway in LAN segment)

_**If you are a beginner following this part, you may skip this section as we already configured the LAN segment adapter without a default gateway.**_ This means internet access will default to the only adapter with a default gateway, which is our NAT adapter.

We need to fix our adapters such that the NAT adapter is used for internet connections and the LAN segment adapter handles the connections between other VMs while still having a default gateway. We can do this by changing the configuration file for the network adapters so the NAT adapter takes priority when accessing online resources.

1. Once logged into the server, execute the following commands:  
    `sudo ls /etc/netplan/`. You should see a file named `50-cloud-init.yaml`.  
    After confirming the existence of the config file, execute `sudo nano /etc/netplan/50-cloud-init.yaml`.
    
2. Once inside the text editor, you should see something like this:
    


```
network:
	version: 2
	ethernets:
		ens33:
			dhcp4: true
		ens34:
			addresses:
			- "192.168.1.1/24"
```


In the example above, the NAT adapter is the one with `dhcp4: true` beneath it, which in this case is `ens33`. The LAN segment adapter contains the IP address we assigned it during the initial setup.

Use the arrow keys to navigate between lines and the `Tab` key on your keyboard to make proper indentations. **.yaml files are very particular about indentation, and you will receive an error if it is not done properly.** Edit the file such that it looks like this:

```
network:
	version: 2
	ethernets:
		ens33:
			dhcp4: true
			dhcp4-overrides:
				route-metric: 100
		ens34:
			addresses:
			- "192.168.1.1/24"
			routes:
			- to: "default"
			  via: 192.168.1.2 #comment: this is the default gateway address
			  metric: 200
```

Assigning a lower metric prioritizes the respective adapter when making Internet connections, while the higher metric is the "backup" route, so it remains unused for Internet connections.

---

## VI. Wazuh Installation

1. Once logged into the server, execute the following command:  
    `curl -sO https://packages.wazuh.com/4.12/wazuh-install.sh && sudo bash ./wazuh-install.sh -a`  
    This command uses `curl`, a tool used to access web pages via the command line. We use this to download the install script for Wazuh and execute it.
    
2. Wait for the installation to finish. Once finished, you should see something like this:
    
```
INFO: --- Summary --- INFO: You can access the web interface https://<WAZUH_DASHBOARD_IP_ADDRESS>     User: admin     Password: <ADMIN_PASSWORD> INFO: Installation finished.
```

Make note of the admin password. On Windows, you can use the snipping tool by pressing `Windows + Shift + S` to take a screenshot of the password. You can change it later.
2. You will see that it tells you to access the web interface via `https://<WAZUH_DASHBOARD_IP_ADDRESS>`. The Wazuh Dashboard IP address is the IP address of the LAN segment adapter, the one we set during the initial setup of Ubuntu Server; in this guide, we used `192.168.1.1`.  
	**a.** If you do not have another virtual machine set up, you cannot access the dashboard at the moment. If you do, open a browser and type the following into your URL bar:  
		`https://<server_ip_here>` | as stated previously, we assigned `192.168.1.1` to the LAN segment, so you would enter `https://192.168.1.1`.  
3. Wazuh is now installed on your Ubuntu Server VM and is ready to start logging events from agents. See the next document about deploying Wazuh Agents on endpoints you want to observe.

---

## VII. Security Considerations

This setup does not consider server hardening, secure communications, firewalls, etc. If you are using this guide for sensitive data or in a business/enterprise environment, consult with the necessary people to ensure that the server architecture is secure and the data remains confidential and available to those who require it.

